# Example GitHub Actions workflow for Playwright E2E tests
# This file demonstrates how to run Playwright tests in CI/CD
# Copy this to .GitHub/workflows/ to enable automated testing

name: Playwright E2E Tests

permissions:
  checks: write
  contents: read

on:
  push:
    branches:
      - main
    paths:
      - "src/**"
      - "e2e/**"
      - "!**.md"
      - "!tests/**"
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
    branches:
      - "*"
    paths:
      - "src/**"
      - "e2e/**"
      - "!**.md"
      - "!tests/**"

  workflow_dispatch:
    inputs:
      reason:
        description: "The reason for running the workflow"
        required: true
        default: "Manual run"

jobs:
  test:
    timeout-minutes: 80
    runs-on: ubuntu-latest

    env:
      NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages
      E2E_HEADLESS: "true"
      E2E_BASE_URL: "http://localhost:5057"
      AUTH0_E2E_USERNAME: ${{ secrets.AUTH0_E2E_USERNAME }}
      AUTH0_E2E_PASSWORD: ${{ secrets.AUTH0_E2E_PASSWORD }}
      AUTH0_E2E_USERNAME_ADMIN: ${{ secrets.AUTH0_E2E_USERNAME_ADMIN }}
      AUTH0_E2E_PASSWORD_ADMIN: ${{ secrets.AUTH0_E2E_PASSWORD_ADMIN }}
      AUTH0_E2E_PASSWORD_AUTHOR: ${{ secrets.AUTH0_E2E_PASSWORD_AUTHOR }}
      AUTH0_E2E_USERNAME_USER: ${{ secrets.AUTH0_E2E_USERNAME_USER }}
      AUTH0_E2E_PASSWORD_USER: ${{ secrets.AUTH0_E2E_PASSWORD_USER }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Restore .NET dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --no-restore

      - name: Install Playwright dependencies
        working-directory: e2e/Web.Tests.Playwright
        run: |
          npm ci
          npx playwright install --with-deps chromium

      - name: Start application
        run: |
          dotnet run --project src/AppHost &
          sleep 50
        env:
          ASPNETCORE_ENVIRONMENT: Development

      - name: Wait for application to be ready
        run: |
          timeout 80 bash -c 'until curl -f http://localhost:5057; do sleep 2; done'

      - name: Run Playwright e2e
        working-directory: e2e/Web.Tests.Playwright
        run: npm test
        env:
          BASE_URL: http://localhost:5057

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: e2e/Web.Tests.Playwright/playwright-report/
          retention-days: 30

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-test-results
          path: e2e/Web.Tests.Playwright/test-results/
          retention-days: 30
