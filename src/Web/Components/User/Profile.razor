@page "/profile"

@using System.Security.Claims
@attribute [Authorize]

<PageHeadingComponent Level="1" HeaderText="@_pageTitle" />

<div class="container mx-auto">

	<AuthorizeView>
		<Authorized>
			<div class="container-card">
				<h2 class="text-2xl font-semibold text-gray-100 mb-4">Profile Information</h2>

				<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
					<div>
						<h3 class="text-lg font-semibold text-gray-100 mb-2">Basic Information</h3>
						<div class="space-y-2">
							<p class="text-gray-300">
								<span class="font-medium">Name:</span>
								@_username
							</p>
							<p class="text-gray-300">
								<span class="font-medium">Email:</span>
								@_emailAddress
							</p>
							<p class="text-gray-300">
								<span class="font-medium">User ID:</span>
								@_userId
							</p>
						</div>
					</div>

					<div>
						<h3 class="text-lg font-semibold text-gray-100 mb-2">Roles & Permissions</h3>
						<div class="space-y-2">
							@{
								var roles = context.User.FindAll(ClaimTypes.Role).ToList();
							}
							@if (roles.Any())
							{
								<p class="text-gray-300">
									<span class="font-medium">Roles:</span>
								</p>
								<ul class="list-disc list-inside text-gray-300 ml-4">
									@foreach (var role in _roles)
									{
										<li class="text-green-400">@role</li>
									}
								</ul>
							}
							else
							{
								<p class="text-gray-400">No roles assigned</p>
							}
						</div>
					</div>
				</div>
				<div class="mt-4">
					<span class="font-medium text-gray-300">Profile Picture:</span>
					@if (!string.IsNullOrEmpty(_picture))
					{
						<img src="@_picture" alt="Profile Picture"
								class="mt-2 rounded-full w-24 h-24 object-cover border-2 border-gray-600"/>
					}
					else
					{
						<div
							class="mt-2 rounded-full w-24 h-24 bg-gray-700 flex items-center justify-center border-2 border-gray-600">
							<span class="text-gray-400 text-2xl">?</span>
						</div>
					}
				</div>
			</div>

			<div class="container-card">
				<h2 class="text-2xl font-semibold text-gray-100 mb-4">All Claims</h2>
				<p class="text-gray-400 text-sm mb-4">Debug information showing all claims for this user:</p>

				<div class="bg-gray-800 rounded p-4 overflow-auto">
					<table class="w-full text-sm">
						<thead>
							<tr class="border-b border-gray-600">
								<th class="text-left text-gray-300 pb-2">Claim Type</th>
								<th class="text-left text-gray-300 pb-2">Value</th>
							</tr>
						</thead>
						<tbody>
							@foreach (var claim in context.User.Claims.OrderBy(c => c.Type))
							{
								<tr class="border-b border-gray-700">
									<td class="py-1 text-gray-400">@claim.Type</td>
									<td class="py-1 text-gray-300">@claim.Value</td>
								</tr>
							}
						</tbody>
					</table>
				</div>
			</div>
		</Authorized>
	</AuthorizeView>
</div>

@code {

	private const string _pageTitle = "User Profile";

	[CascadingParameter] private Task<AuthenticationState>? AuthenticationState { get; set; }

	private string _userId = "";

	private string _username = "";

	private string _emailAddress = "";

	private string _picture = "";

	private List<string> _roles = [];

	protected override async Task OnInitializedAsync()
	{

		if (AuthenticationState is not null)
		{
			var state = await AuthenticationState;

			_username = state.User.Identity?.Name ?? string.Empty;

			_userId = state.User.Claims
					.Where(c => c.Type.Equals(ClaimTypes.NameIdentifier))
					.Select(c => c.Value)
					.FirstOrDefault() ?? string.Empty;

			_emailAddress = state.User.Claims
					.Where(c => c.Type.Equals(ClaimTypes.Email))
					.Select(c => c.Value)
					.FirstOrDefault() ?? string.Empty;

			_picture = state.User.Claims
					.Where(c => c.Type.Equals("picture"))
					.Select(c => c.Value)
					.FirstOrDefault() ?? string.Empty;

			_roles = state.User.Claims
					.Where(c => c.Type == "role" || c.Type == "roles")
					.Select(c => c.Value)
					.ToList();

			await base.OnInitializedAsync();
		}

	}

}