@page "/categories/create"

@inject NavigationManager Navigation
@inject CreateCategory.ICreateCategoryHandler CreateHandler
@inject ILogger<Create> Logger

@attribute [Authorize(Roles = "Admin")]

<PageHeadingComponent HeaderText="Create New Category" Level="1" TextColorClass="blue-500" />

@if (_isSubmitting)
{
	<LoadingComponent />
}
else
{
	<div class="container-card bg-gray-700 rounded-lg shadow-lg p-8 max-w-2xl mx-auto mt-6">
		<EditForm Model="@_category" OnValidSubmit="HandleSubmit">
			<DataAnnotationsValidator />
			<ValidationSummary />

			@if (!string.IsNullOrEmpty(_errorMessage))
			{
				<ErrorAlertComponent Title="Error creating category">
					@_errorMessage
				</ErrorAlertComponent>
			}

			<div class="mb-6">
				<label for="categoryName" class="block text-gray-300 font-semibold mb-2">Category Name</label>
				<InputText id="categoryName"
					class="form-control bg-gray-800 text-white border-blue-500 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
					@bind-Value="_category.CategoryName" placeholder="Enter category name" />
				<ValidationMessage For="@(() => _category.CategoryName)" />
			</div>

			<div class="mt-8 flex gap-3 justify-end">
				<button type="submit"
					class="btn-primary"
					disabled="@_isSubmitting">
					@if (_isSubmitting)
					{
						<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
						<span>Creating...</span>
					}
					else
					{
						<span>Create Category</span>
					}
				</button>
				<button type="button"
					class="btn-secondary"
					@onclick="GoToList" disabled="@_isSubmitting">Cancel</button>
			</div>
		</EditForm>
	</div>
}

@code {

	[CascadingParameter] private Task<AuthenticationState>? AuthenticationState { get; set; }

	/// <summary>
	/// The category data being created.
	/// </summary>
	private CategoryDto _category = new();

	/// <summary>
	/// Indicates whether the form is currently being submitted.
	/// </summary>
	private bool _isSubmitting;

	/// <summary>
	/// Error message to display if creation fails.
	/// </summary>
	private string? _errorMessage;

	/// <summary>
	/// Handles the form submission to create a new category.
	/// </summary>
	private async Task HandleSubmit()
	{
		Logger?.LogInformation("Creating new category: {CategoryName}", _category.CategoryName);
		_isSubmitting = true;
		_errorMessage = null;

		try
		{
			var result = await CreateHandler.HandleAsync(_category);

			if (result is { Success: true })
			{
				Logger?.LogInformation("Category created successfully with ID: {CategoryId}", result.Value?.Id);
				Navigation.NavigateTo("/categories");
			}
			else
			{
				_errorMessage = result.Error ?? "Failed to create category.";
				Logger?.LogWarning("Failed to create category. Error: {Error}", _errorMessage);
			}

		}
		catch (Exception ex)
		{
			_errorMessage = $"An unexpected error occurred: {ex.Message}";
			Logger?.LogError(ex, "Exception while creating category");
		}
		finally
		{
			_isSubmitting = false;
		}
	}

	/// <summary>
	/// Navigates back to the category list page.
	/// </summary>
	private void GoToList()
	{
		Navigation.NavigateTo("/categories");
	}

}