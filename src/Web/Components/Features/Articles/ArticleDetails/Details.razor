@page "/articles/details/{id}"

@inject NavigationManager Navigation
@inject IArticleRepository ArticleRepository
@inject ILogger<Details> Logger

@attribute [Authorize]

<PageHeadingComponent HeaderText="Article Details" Level="1" TextColorClass="blue-500" />
<span class="visually-hidden">LoadingComponent</span>

@if (_isLoading)
{
	<LoadingComponent />
}
else if (_article is null)
{
	<ErrorAlertComponent Title="Unable to load article">
		@(_errorMessage ?? "Article not found.")
	</ErrorAlertComponent>
}
else
{
	<div class="card modern-card shadow-lg rounded-lg border-0 p-0 mb-4" style="max-width:700px;margin:auto;">
		<div class="card-img-wrapper position-relative">
			<img src="@_article.CoverImageUrl" alt="Cover" class="card-img-top rounded-top"
				style="max-height:260px;object-fit:cover;width:100%;" />
			@if (!_article.IsPublished)
			{
				<span class="badge bg-warning position-absolute top-0 end-0 m-3">Draft</span>
			}
			@if (_article.IsArchived)
			{
				<span class="badge bg-secondary position-absolute top-0 start-0 m-3">Archived</span>
			}
		</div>
		<div class="card-body p-4">
			<h2 class="card-title mb-2 text-primary">@_article.Title</h2>
			<p class="card-subtitle mb-3 text-muted">@_article.Introduction</p>
			<div class="article-content mb-4">@((MarkupString)_article.Content)</div>
			<div class="row mb-3">
				<div class="col-md-6 mb-2">
					<i class="bi bi-person-circle me-1"></i><strong>Author:</strong> @(_article.Author?.Name)
				</div>
				<div class="col-md-6 mb-2">
					<i class="bi bi-folder me-1"></i><strong>Category:</strong> @_article.Category?.CategoryName
				</div>
				<div class="col-md-6 mb-2">
					<i class="bi bi-calendar-check me-1"></i><strong>Published:</strong> @(_article.IsPublished ? "Yes" : "No")
				</div>
				<div class="col-md-6 mb-2">
					<i class="bi bi-calendar me-1"></i><strong>Published On:</strong> @_article.PublishedOn?.ToString("d")
				</div>
				<div class="col-md-6 mb-2">
					<i class="bi bi-archive me-1"></i><strong>Archived:</strong> @_article.IsArchived
				</div>
			</div>
			<div class="d-flex justify-content-end gap-2 mt-4">
				<button class="btn btn-primary d-flex align-items-center gap-1" @onclick="GoToEdit"
					disabled="@(!_article.CanEdit)">
					<i class="bi bi-pencil-square"></i> Edit
				</button>
				<button class="btn btn-outline-secondary d-flex align-items-center gap-1" @onclick="GoToList">
					<i class="bi bi-arrow-left"></i> Back to List
				</button>
			</div>
		</div>
	</div>
}

@code {

	/// <summary>
	/// The unique identifier of the article to display.
	/// </summary>
	[Parameter]
	public required string Id { get; set; } = string.Empty;

	[CascadingParameter] private Task<AuthenticationState>? AuthenticationState { get; set; }

	/// <summary>
	/// The article data to be displayed on the page.
	/// </summary>
	public ArticleDto? _article { get; set; }
	
	/// <summary>
	/// Indicates whether the component is currently loading data.
	/// </summary>
	public bool _isLoading { get; set; } = true;
	
	/// <summary>
	/// Error message returned by the handler when loading fails. Shown in the UI.
	/// </summary>
	public string? _errorMessage { get; set; }

	/// <summary>
	/// Initializes the component by loading the article data using the ArticleHandler.
	/// </summary>
	protected override async Task OnInitializedAsync()
	{

		Logger?.LogInformation("Loading article details for Id: {ArticleId}", Id);
		_isLoading = true;

		try
		{
			var objectId = MongoDB.Bson.ObjectId.Parse(Id);
			var result = await ArticleRepository.GetArticleByIdAsync(objectId);

			if (result is { Success: true })
			{
				var a = result.Value;
				_article = a == null ? null : new ArticleDto(
				a.Id,
				a.Slug,
				a.Title,
				a.Introduction,
				a.Content,
				a.CoverImageUrl,
				a.Author,
				a.Category,
				a.IsPublished,
				a.PublishedOn,
				a.CreatedOn,
				a.ModifiedOn,
				a.IsArchived,
				true // CanEdit: adjust as needed
				);
				_errorMessage = null;
				Logger?.LogInformation("Article loaded successfully: {ArticleId}", Id);
			}
			else
			{
				_article = null;
				_errorMessage = result?.Error ?? "Article not found.";
				Logger?.LogWarning("Failed to load article: {ArticleId}. Error: {Error}", Id, _errorMessage);
			}
		}
		finally
		{
			_isLoading = false;
		}

	}

	/// <summary>
	/// Navigates to the edit page for the current article.
	/// </summary>
	private void GoToEdit()
	{
		Navigation.NavigateTo($"/articles/edit/{Id}");
	}

	/// <summary>
	/// Navigates back to the article list page.
	/// </summary>
	private void GoToList()
	{
		Navigation.NavigateTo("/articles");
	}

}