@page "/articles/details/{id}"

@using Markdig

@inject NavigationManager Navigation
@inject GetArticle.IGetArticleHandler GetArticleHandler
@inject ILogger<Details> Logger

@attribute [Authorize]

<PageHeadingComponent HeaderText="Article Details" Level="1" TextColorClass="blue-500" />

@if (IsLoading)
{
	<LoadingComponent />
}
else if (@ErrorMessage is not null)
{
	<ErrorAlertComponent Title="Unable to load article">
		@(ErrorMessage ?? "Article not found.")
	</ErrorAlertComponent>
}
else
{
	<div class="container-card p-2">
		<div class="card-img-wrapper position-relative">
			<img src="@Article.CoverImageUrl" alt="Cover" class="card-img-top rounded-md"
					 style="max-height:260px;object-fit:cover;width:100%;" />
		</div>
		<div class="card-title p-4">
			@if (!Article.IsPublished)
			{
				<h4 class="py-2 px-4 font-bold text-yellow-400 rounded-md shadow-md shadow-yellow-500">Draft</h4>
			}
			@if (Article.IsPublished)
			{
				<h4 class="py-2 px-4 font-bold text-green-400 rounded-md shadow-md shadow-green-500">Published</h4>
			}
			@if (Article.IsArchived)
			{
				<h4 class="py-2 px-4 font-bold text-red-400 rounded-md shadow-md shadow-red-500">Archived</h4>
			}
		</div>
		<div class="card-body p-4">
			<h2 class="card-title mb-2 text-primary">@Article.Title</h2>
			<p class="card-subtitle mb-3 text-muted">@Article.Introduction</p>
			<div class="row mb-3">
				<div class="col-md-6 mb-2">
					<i class="bi bi-person-circle me-1"></i><strong>Author:</strong> @(Article.Author?.Name)
				</div>
				<div class="col-md-6 mb-2">
					<i class="bi bi-folder me-1"></i><strong>Category:</strong> @Article.Category?.CategoryName
				</div>
				<div class="col-md-6 mb-2">
					<i class="bi bi-calendar-check me-1"></i><strong>Published:</strong> @(Article.IsPublished ? "Yes" : "No")
				</div>
				<div class="col-md-6 mb-2">
					<i class="bi bi-calendar me-1"></i><strong>Published On:</strong> @Article.PublishedOn?.ToString("d")
				</div>
				<div class="col-md-6 mb-2">
					<i class="bi bi-archive me-1"></i><strong>Archived:</strong> @Article.IsArchived
				</div>
				<div class="article-content mb-4">
					@((MarkupString)Markdown.ToHtml(Article.Content))
				</div>
			</div>
			<div class="mt-4 flex gap-2">
				@if (@Article.CanEdit)
				{
					<button class="bg-green-500 text-white px-3 py-1 rounded hover:bg-blue-600" @onclick="GoToEdit">
						<i class="bi bi-pencil-square"></i> Edit
					</button>
				}

				<button class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600" @onclick="GoToList">
					<i class="bi bi-arrow-left"></i> Back to List
				</button>
			</div>
		</div>
	</div>
}

@code {

	/// <summary>
	/// The unique identifier of the article to display.
	/// </summary>
	[Parameter]
	public required string Id { get; set; } = string.Empty;

	private ObjectId RecordId { get; set; } = ObjectId.Empty;

	[CascadingParameter] private Task<AuthenticationState>? AuthenticationState { get; set; }

	/// <summary>
	/// The article data to be displayed on the page.
	/// </summary>
	private ArticleDto Article { get; set; } = ArticleDto.Empty;

	/// <summary>
	/// Indicates whether the component is currently loading data.
	/// </summary>
	private bool IsLoading { get; set; } = true;

	/// <summary>
	/// Error message returned by the handler when loading fails. Shown in the UI.
	/// </summary>
	private string? ErrorMessage { get; set; }

	/// <summary>
	/// Initializes the component by loading the article data using the ArticleHandler.
	/// </summary>
	protected override async Task OnInitializedAsync()
	{

		RecordId = ObjectId.Parse(Id);

		Logger?.LogInformation("Loading article details for Id: {ArticleId}", RecordId);
		IsLoading = true;

		try
		{
			var articleResult = await GetArticleHandler.HandleAsync(RecordId);

			if (articleResult is { Success: true, Value: not null })
			{
				Article = articleResult.Value;
				Article.CanEdit = await UserCanEditArticleAsync(Article);
				ErrorMessage = null;
			}
			else
			{
				ErrorMessage = articleResult.Error ?? "Article not found.";
			}
		}
		catch (Exception ex)
		{
			ErrorMessage = ex.Message;
			Logger?.LogError(ex, "Error loading article for edit: {ArticleId}", RecordId);
		}
		finally
		{
			IsLoading = false;
		}
	}

	/// <summary>
	/// Determines whether the current user can edit the specified article.
	/// User can edit when they are in the \`Admin\` role or when they are the article's author.
	/// </summary>
	private async Task<bool> UserCanEditArticleAsync(ArticleDto? a)
	{
		if (AuthenticationState is null)
		{
			return false;
		}

		var authState = await AuthenticationState;
		var user = authState.User;

		if (user.Identity?.IsAuthenticated != true)
		{
			return false;
		}

		try
		{
			if (user.IsInRole("Admin"))
			{
				return true;
			}

			// Prefer stable identifier claims (Auth0 uses "sub"). Fall back to NameIdentifier.
			var currentUserId = user.FindFirst("sub")?.Value
													?? user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

			var authorId = a?.Author?.UserId;

			if (!string.IsNullOrEmpty(currentUserId) && !string.IsNullOrEmpty(authorId))
			{
				return string.Equals(currentUserId, authorId, StringComparison.OrdinalIgnoreCase);
			}
		}
		catch (Exception ex)
		{
			Logger?.LogWarning(ex, "Error evaluating edit permission for article {ArticleId}", a?.Id);
		}

		return false;
	}

	/// <summary>
	/// Navigates to the edit page for the current article.
	/// </summary>
	private void GoToEdit()
	{
		Navigation.NavigateTo($"/articles/edit/{RecordId}");
	}

	/// <summary>
	/// Navigates back to the article list page.
	/// </summary>
	private void GoToList()
	{
		Navigation.NavigateTo("/articles");
	}

}