@page "/articles/edit/{id}"

@inject NavigationManager Navigation
@inject IArticleRepository ArticleRepository
@inject ILogger<Edit> Logger

@attribute [Authorize]

<PageHeadingComponent HeaderText="Edit Article" Level="1" TextColorClass="blue-500" />
<span class="visually-hidden">LoadingComponent</span>

@if (_isLoading)
{
	<LoadingComponent />
	<span class="visually-hidden">LoadingComponent</span>
}
else if (_errorMessage is not null)
{
	<ErrorAlertComponent Title="Unable to load article">
		@_errorMessage
	</ErrorAlertComponent>
}
else if (_editModel is not null)
{
	<div class="card modern-card shadow-lg rounded-lg border-0 p-0 mb-4" style="max-width:700px;margin:auto;">
		<div class="card-body p-4">
			<EditForm Model="_editModel" OnValidSubmit="HandleValidSubmit">
				<DataAnnotationsValidator />
				<ValidationSummary />
				<div class="mb-3">
					<label for="title" class="form-label">Title</label>
					<InputText id="title" class="form-control" @bind-Value="_editModel.Title" />
				</div>
				<div class="mb-3">
					<label for="introduction" class="form-label">Introduction</label>
					<InputText id="introduction" class="form-control" @bind-Value="_editModel.Introduction" />
				</div>
				<div class="mb-3">
					<label for="content" class="form-label">Content</label>
					<InputTextArea id="content" class="form-control" @bind-Value="_editModel.Content" rows="8" />
				</div>
				<div class="mb-3">
					<label for="coverImageUrl" class="form-label">Cover Image URL</label>
					<InputText id="coverImageUrl" class="form-control" @bind-Value="_editModel.CoverImageUrl" />
				</div>
				<div class="row mb-3">
					<div class="col-md-6 mb-2">
						<label class="form-label">Category</label>
						<InputText class="form-control" @bind-Value="_editModel.CategoryName" />
					</div>
					<div class="col-md-6 mb-2">
						<label class="form-label">Author</label>
						<InputText class="form-control" @bind-Value="_editModel.AuthorName" />
					</div>
				</div>
				<div class="row mb-3">
					<div class="col-md-6 mb-2">
						<div class="form-check">
							<InputCheckbox id="isPublished" class="form-check-input" @bind-Value="_editModel.IsPublished" />
							<label for="isPublished" class="form-check-label">Published</label>
						</div>
					</div>
					<div class="col-md-6 mb-2">
						<div class="form-check">
							<InputCheckbox id="isArchived" class="form-check-input" @bind-Value="_editModel.IsArchived" />
							<label for="isArchived" class="form-check-label">Archived</label>
						</div>
					</div>
				</div>
				<div class="d-flex justify-content-end gap-2 mt-4">
					<button type="submit" class="btn btn-success d-flex align-items-center gap-1">
						<i class="bi bi-save"></i> Save
					</button>
					<button type="button" class="btn btn-outline-secondary d-flex align-items-center gap-1" @onclick="GoToDetails">
						<i class="bi bi-arrow-left"></i> Cancel
					</button>
				</div>
			</EditForm>
		</div>
	</div>
}

@code {
	[Parameter]
	public required string Id { get; set; } = string.Empty;

	private ArticleEditModel? _editModel;
	private bool _isLoading = true;
	private string? _errorMessage;

	protected override async Task OnInitializedAsync()
	{
		Logger?.LogInformation("Loading article for edit: {ArticleId}", Id);
		_isLoading = true;
		try
		{
			var objectId = ObjectId.Parse(Id);
			var result = await ArticleRepository.GetArticleByIdAsync(objectId);
			if (result is { Success: true })
			{
				var a = result.Value;
				if (a != null)
				{
					_editModel = new ArticleEditModel
					{
						Id = a.Id.ToString(),
						Title = a.Title,
						Introduction = a.Introduction,
						Content = a.Content,
						CoverImageUrl = a.CoverImageUrl,
						CategoryName = a.Category?.CategoryName ?? string.Empty,
						AuthorName = a.Author?.Name ?? string.Empty,
						IsPublished = a.IsPublished,
						IsArchived = a.IsArchived
					};
					_errorMessage = null;
				}
				else
				{
					_errorMessage = "Article not found.";
				}
			}
			else
			{
				_errorMessage = result.Error ?? "Article not found.";
			}
		}
		catch (Exception ex)
		{
			_errorMessage = ex.Message;
			Logger?.LogError(ex, "Error loading article for edit: {ArticleId}", Id);
		}
		finally
		{
			_isLoading = false;
		}
	}

	private async Task HandleValidSubmit()
	{
		_isLoading = true;
		try
		{
			if (_editModel is null) return;
			// Convert ArticleEditModel to Article
			var article = new Article
			{
				Id = ObjectId.Parse(_editModel.Id),
				Title = _editModel.Title,
				Introduction = _editModel.Introduction,
				Content = _editModel.Content,
				CoverImageUrl = _editModel.CoverImageUrl,
				Category = new Category { CategoryName = _editModel.CategoryName },
				Author = new AuthorInfo { Name = _editModel.AuthorName },
				IsPublished = _editModel.IsPublished,
				IsArchived = _editModel.IsArchived
			};
			var updateResult = await ArticleRepository.UpdateArticle(article);
			if (updateResult.Success)
			{
				Navigation.NavigateTo($"/articles/details/{_editModel.Id}");
			}
			else
			{
				_errorMessage = updateResult.Error ?? "Failed to update article.";
			}
		}
		catch (Exception ex)
		{
			_errorMessage = ex.Message;
			Logger?.LogError(ex, "Error updating article: {ArticleId}", _editModel?.Id);
		}
		finally
		{
			_isLoading = false;
		}
	}

	private void GoToDetails()
	{
		Navigation.NavigateTo($"/articles/details/{Id}");
	}

	public class ArticleEditModel
	{
		public string Id { get; set; } = string.Empty;
		public string Title { get; set; } = string.Empty;
		public string Introduction { get; set; } = string.Empty;
		public string Content { get; set; } = string.Empty;
		public string CoverImageUrl { get; set; } = string.Empty;
		public string CategoryName { get; set; } = string.Empty;
		public string AuthorName { get; set; } = string.Empty;
		public bool IsPublished { get; set; }
		public bool IsArchived { get; set; }
	}
}