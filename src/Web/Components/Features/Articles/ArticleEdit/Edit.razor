@page "/articles/edit/{Id}"

@using Web.Components.Features.Articles.ArticleDetails
@inject NavigationManager Navigation
@inject ILogger<Edit> Logger
@inject GetCategories.IGetCategoriesHandler GetCategoriesHandler
@inject GetArticle.IGetArticleHandler GetArticleHandler
@inject EditArticle.IEditArticleHandler EditArticleHandler

@attribute [Authorize]

@if (_isLoading)
{
	<LoadingComponent />
}
else if (_errorMessage is not null)
{
	<ErrorAlertComponent Title="Unable to load article">
		@_errorMessage
	</ErrorAlertComponent>
}
else if (_editModel != ArticleDto.Empty)
{
	<EditForm Model="_editModel" OnValidSubmit="HandleValidSubmit">
		<DataAnnotationsValidator />
		<ValidationSummary />
		<div class="mb-3">
			<label class="form-label">Title</label>
			<InputText class="form-control" @bind-Value="_editModel.Title" />
		</div>
		<div class="mb-3">
			<label class="form-label">Introduction</label>
			<InputTextArea class="form-control" @bind-Value="_editModel.Introduction" rows="2" />
		</div>
		<div class="row mb-3">
			<div class="col-md-6 mb-2">
				<label class="form-label"><i class="bi bi-folder me-1"></i> Category</label>
				<InputSelect class="form-control" @bind-Value="_selectedCategoryId" @onchange="OnCategoryChanged">
					<option value="">Select a category</option>
					@if (_categories != null && _categories.Any())
					{
						foreach (var cat in _categories)
						{
							<option value="@cat.Id.ToString()">@cat.CategoryName</option>
						}
					}
				</InputSelect>
			</div>
			<div class="col-md-6 mb-2">
				<label class="form-label">
					<i class="bi bi-person-circle me-1"></i> Author
					<i class="bi bi-lock-fill text-secondary ms-1" title="Not editable"></i>
				</label>
				<div class="form-control-plaintext ps-2 fw-bold text-primary">
					@_editModel.Author?.Name
				</div>
			</div>
			<div class="col-md-6 mb-2">
				<div class="form-check">
					<InputCheckbox id="isPublishedEdit" class="form-check-input" @bind-Value="_editModel.IsPublished" />
					<label for="isPublishedEdit" class="form-check-label">Published</label>
				</div>
			</div>
			<div class="col-md-6 mb-2">
				<div class="form-check">
					<InputCheckbox id="isArchivedEdit" class="form-check-input" @bind-Value="_editModel.IsArchived" />
					<label for="isArchivedEdit" class="form-check-label">Archived</label>
				</div>
			</div>
		</div>
		<div class="mb-3">
			<label class="form-label">Content (Markdown)</label>
			<TextEditor @bind-Content="@_editModel.Content" AlignmentOptionsEnabled="true" />
		</div>
		<div class="mt-4 flex gap-2">
			<button type="submit" class="btn-primary">
				<i class="bi bi-save"></i> Save
			</button>
			<button type="button" class="btn-secondary"
				@onclick="@(() => Navigation.NavigateTo($"/articles/details/{Id}"))">
				<i class="bi bi-arrow-left"></i> Cancel
			</button>
		</div>
	</EditForm>
}

@code {

	[Parameter] public required string Id { get; set; } = string.Empty;

	private ObjectId RecordId { get; set; } = ObjectId.Empty;

	[CascadingParameter] private Task<AuthenticationState>? AuthenticationState { get; set; }

	private ArticleDto _editModel = ArticleDto.Empty;

	private bool _isLoading = true;

	private string? _errorMessage;

	private List<CategoryDto>? _categories;
	
	// private bool _showRawMarkdown;

	private string _selectedCategoryId = string.Empty;

	protected override async Task OnInitializedAsync()
	{

		RecordId = ObjectId.Parse(Id);

		Logger?.LogInformation("Loading article for edit: {ArticleId}", RecordId);
		_isLoading = true;

		try
		{
			// Load categories for the category dropdown
			await LoadCategoriesAsync();

			var articleResult = await GetArticleHandler.HandleAsync(RecordId);

			if (articleResult is { Success: true, Value: not null })
			{
				_editModel = articleResult.Value;
				_editModel.CanEdit = await UserCanEditArticleAsync(_editModel);
				_selectedCategoryId = _editModel.Category?.Id.ToString() ?? string.Empty;
				//UpdatePreview();
				_errorMessage = null;
			}
			else
			{
				_errorMessage = articleResult.Error ?? "Article not found.";
			}
		}
		catch (Exception ex)
		{
			_errorMessage = ex.Message;
			Logger?.LogError(ex, "Error loading article for edit: {ArticleId}", RecordId);
		}
		finally
		{
			_isLoading = false;
		}
	}

	/// <summary>
	/// Determines whether the current user can edit the specified article.
	/// User can edit when they are in the \`Admin\` role or when they are the article's author.
	/// </summary>
	private async Task<bool> UserCanEditArticleAsync(ArticleDto? a)
	{
		if (AuthenticationState is null)
		{
			return false;
		}

		var authState = await AuthenticationState;
		var user = authState.User;

		if (user.Identity?.IsAuthenticated != true)
		{
			return false;
		}

		try
		{
			if (user.IsInRole("Admin"))
			{
				return true;
			}

			// Prefer stable identifier claims (Auth0 uses "sub"). Fall back to NameIdentifier.
			var currentUserId = user.FindFirst("sub")?.Value
													?? user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

			var authorId = a?.Author?.UserId;

			if (!string.IsNullOrEmpty(currentUserId) && !string.IsNullOrEmpty(authorId))
			{
				return string.Equals(currentUserId, authorId, StringComparison.OrdinalIgnoreCase);
			}
		}
		catch (Exception ex)
		{
			Logger?.LogWarning(ex, "Error evaluating edit permission for article {ArticleId}", a?.Id);
		}

		return false;
	}

	private async Task HandleValidSubmit()
	{
		if (_editModel == ArticleDto.Empty)
		{
			_errorMessage = "Nothing to save.";
			Logger?.LogWarning("HandleValidSubmit: _editModel was null for {ArticleId}", RecordId);

			return;
		}

		try
		{
			// Ensure the selected category is applied to the edit model
			if (!string.IsNullOrWhiteSpace(_selectedCategoryId) && ObjectId.TryParse(_selectedCategoryId, out var selectedCatId))
			{
				var selectedCategory = _categories?.FirstOrDefault(c => c.Id == selectedCatId);

				if (selectedCategory != null)
				{
					_editModel.Category = new Category
					{
						Id = selectedCategory.Id,
						CategoryName = selectedCategory.CategoryName,
						IsArchived = selectedCategory.IsArchived
					};
				}
			}
			else
			{
				// Allow clearing the category
				_editModel.Category = null;
			}

			var result = await EditArticleHandler.HandleAsync(_editModel);

			if (result.Success)
			{
				Logger?.LogInformation("Article saved: {ArticleId}", RecordId);
				Navigation.NavigateTo($"/articles/details/{RecordId}");
			}
			else
			{
				_errorMessage = result.Error ?? "Failed to save article.";
				Logger?.LogWarning("Failed to save article {ArticleId}: {Error}", RecordId, _errorMessage);
			}
		}
		catch (Exception ex)
		{
			_errorMessage = ex.Message;
			Logger?.LogError(ex, "Error saving article {ArticleId}", RecordId);
		}
	}

	private async Task LoadCategoriesAsync()
	{
		// Load categories using handler and handle errors
		try
		{
			var catResult = await GetCategoriesHandler.HandleAsync();
			_categories = catResult is { Success: true, Value: not null } ? catResult.Value.ToList() : [];

			if (!catResult.Success)
			{
				_errorMessage = catResult.Error ?? "Failed to load categories.";
				Logger?.LogWarning("Failed to load categories: {Error}", _errorMessage);
			}
		}
		catch (Exception ex)
		{
			_categories = [];
			_errorMessage = ex.Message;
			Logger?.LogError(ex, "Error loading categories");
		}
	}

	private void OnCategoryChanged(ChangeEventArgs e)
	{
		var selectedId = e.Value?.ToString() ?? string.Empty;
		_selectedCategoryId = selectedId;

		if (_categories != null && ObjectId.TryParse(selectedId, out var objId) && _categories.Any())
		{
			var selectedCategory = _categories.FirstOrDefault(c => c.Id == objId);

			if (selectedCategory != null)
			{
				_editModel.Category = new Category
				{
					Id = selectedCategory.Id,
					CategoryName = selectedCategory.CategoryName,
					IsArchived = selectedCategory.IsArchived
				};
			}
		}
		else
		{
			_editModel.Category = null;
		}
	}
	//
	// private void UpdatePreview()
	// {
	// 	if (_editModel != ArticleDto.Empty)
	// 	{
	// 		var content = _editModel.Content;
	// 		_previewHtml = Markdown.ToHtml(content, new MarkdownPipelineBuilder().UseAdvancedExtensions().Build());
	// 	}
	// 	else
	// 	{
	// 		_previewHtml = string.Empty;
	// 	}
	// }
	//
	// private void TogglePreviewMode()
	// {
	// 	_showRawMarkdown = !_showRawMarkdown;
	// 	if (!_showRawMarkdown)
	// 	{
	// 		UpdatePreview();
	// 	}
	// }

}