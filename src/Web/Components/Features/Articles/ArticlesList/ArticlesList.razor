@page "/articles"

@using System.Security.Claims
@inject GetArticles.IGetArticlesHandler ArticlesHandler
@inject NavigationManager Navigation
@inject ILogger<ArticlesList> Logger
@inject AuthenticationStateProvider AuthStateProvider

<div class="container-card mb-4 flex items-center justify-between">

    <h1 class="text-2xl">All Articles</h1>

    <label class="flex items-center font-semibold text-gray-900 dark:text-gray-50 transition-colors duration-300">
        <input type="checkbox" @bind="_showMyArticlesOnly" @bind:after="OnFilterChanged" class="mr-2" />
        Show My Articles Only
    </label>

    <label class="flex items-center font-semibold text-gray-900 dark:text-gray-50 transition-colors duration-300">
        <input type="checkbox" @bind="_includeArchived" @bind:after="OnFilterChanged" class="mr-2" />
        Include Archived
    </label>

    @if (_canCreate)
    {
        <button class="btn-secondary"
                @onclick="CreateNewArticle">
            Create
            New Article
        </button>
    }
</div>

@if (_isLoading)
{
    <LoadingComponent />
}
else if (_errorMessage != null)
{
    <ErrorAlertComponent Title="Error loading articles">
        @_errorMessage
    </ErrorAlertComponent>
}
else if (_articles == null || !_articles.Any())
{
    <div class="bg-white dark:bg-gray-700 rounded-lg p-8 text-center transition-colors duration-300">
        <p class="text-gray-700 dark:text-gray-300 text-lg mb-4 transition-colors duration-200">No articles available yet.</p>
        <p class="text-gray-500 dark:text-gray-400 transition-colors duration-200">Check back soon for new content!</p>
    </div>
}
else
{
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        @foreach (var article in _articles)
        {
            <div class="container-card flex flex-col justify-between min-h-[260px]">
                @if (!string.IsNullOrEmpty(article.CoverImageUrl))
                {
                    <img src="@article.CoverImageUrl" alt="@article.Title" style="width:100%;height:33%;object-fit:cover;" />
                }
            <div>
                <h2 class="text-xl mb-2 transition-colors duration-200">@article.Title</h2>
                <hr class="border-blue-700 mb-4" />
                <p class="text-gray-800 dark:text-gray-50 mb-2 transition-colors duration-200" title="@article.Introduction">
                    <span class="font-semibold text-gray-800 dark:text-gray-100 transition-colors duration-200">Intro:</span>
                    @article.Introduction
                </p>
                <div class="mb-2">
                    <span class="font-semibold text-gray-800 dark:text-gray-50 transition-colors duration-200">Author:</span> <span class="text-gray-900 dark:text-gray-100 transition-colors duration-200">@article.Author?.Name</span>
                </div>
                <div class="mb-2">
                    <span class="font-semibold text-gray-800 dark:text-gray-50 transition-colors duration-200">Category:</span>
                    <span class="text-gray-900 dark:text-gray-100 transition-colors duration-200">@article.Category?.CategoryName</span>
                </div>
                <div class="mb-2">
                    <span class="font-semibold text-gray-800 dark:text-gray-50 transition-colors duration-200">Published:</span>
                    <span class="text-gray-900 dark:text-gray-100 transition-colors duration-200">
                        @(article.IsPublished ?
                                            "Yes" : "No")
                        </span>
                    </div>
                    <div class="mb-2">
                        <span class="font-semibold text-gray-800 dark:text-gray-50 transition-colors duration-200">Archived:</span>
                        <span class="text-gray-900 dark:text-gray-100 transition-colors duration-200">
                            @(article.IsArchived ?
                                                "Yes" : "No")
                        </span>
                    </div>
                </div>
                <div class="mt-4 flex gap-2">
                    <button class="btn-secondary" @onclick="() => GoToDetails(article.Id)">Details</button>

                    @if (@article.CanEdit)
                    {
                        <button class="btn-primary" @onclick="() => GoToEdit(article.Id)">
                            <i class="bi bi-pencil-square"></i> Edit
                        </button>
                    }
                </div>
            </div>
        }
    </div>
}

@code {

    [CascadingParameter] private Task<AuthenticationState>? AuthenticationState { get; set; }

    private IEnumerable<ArticleDto>? _articles;
    private bool _showMyArticlesOnly;
    private bool _includeArchived;
    private bool _isLoading = true;
    private string? _errorMessage;
    private bool _canCreate;

    protected override async Task OnInitializedAsync()
    {
        await LoadArticlesAsync();
    }

    private async Task LoadArticlesAsync()
    {
        Logger?.LogInformation("Loading articles list");
        _isLoading = true;
        _errorMessage = null;

        try
        {
            // Get current user for filtering
            System.Security.Claims.ClaimsPrincipal? user = null;
            if (AuthenticationState is not null)
            {
                var authState = await AuthenticationState;
                user = authState.User;

                // Determine if user is Admin or Author
                var isAdmin = user.IsInRole("Admin");
                var isAuthor = user.IsInRole("Author");
                _canCreate = isAdmin || isAuthor;
            }

            // Fetch articles with filtering done by the handler
            var result = await ArticlesHandler.HandleAsync(
                user: user,
                filterByUser: _showMyArticlesOnly,
                includeArchived: _includeArchived);

            if (result.Success)
            {
                _articles = result.Value ?? Enumerable.Empty<ArticleDto>();
                _errorMessage = null;
                Logger?.LogInformation("Articles loaded successfully. Count: {Count}", _articles.Count());
            }
            else
            {
                _articles = null;
                _errorMessage = result.Error ?? "Failed to load articles.";
                Logger?.LogWarning("Failed to load articles. Error: {Error}", _errorMessage);
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Unexpected error: {ex.Message}";
            Logger?.LogError(ex, "Unexpected error while loading articles.");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void GoToDetails(object id)
    {
        Navigation.NavigateTo($"/articles/details/{id}");
    }

    private void GoToEdit(object id)
    {
        Navigation.NavigateTo($"/articles/edit/{id}");
    }

    private void CreateNewArticle()
    {
        Navigation.NavigateTo("/articles/create");
    }

    private async Task OnFilterChanged()
    {
        Logger?.LogInformation("Filter changed - ShowMyArticlesOnly: {ShowMy}, IncludeArchived: {IncludeArchived}", 
            _showMyArticlesOnly, _includeArchived);
        await LoadArticlesAsync();
    }

}
